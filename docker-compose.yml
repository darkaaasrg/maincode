version: "3.9"

services:
  # Ваш API (Оновлений)
  api:
    build:
      context: ./backend 
      dockerfile: Dockerfile
    container_name: music_catalog_api
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      PORT: 5000
      # Тут ваша IP для БД (локальна або зовнішня, яку ми налаштували раніше)
      DB_URL: mysql://vinilcasethub:1111111@10.10.10.73:3306/vinilcasethub
      JWT_SECRET: YOUR_SUPER_SECRET_KEY_FOR_JWT
      # Вказуємо адресу колектора
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
    depends_on:
      - otel-collector

  # Ваш Web (Без змін, але додали depends_on)
  web:
    build:
      context: ./frontend 
      dockerfile: Dockerfile
    container_name: music_catalog_web
    restart: unless-stopped
    depends_on:
      - api
    ports:
      - "5173:80" 
    environment:
      REACT_APP_API_BASE_URL: "http://localhost:5000/api"

  # --- OBSERVABILITY STACK ---

  # 1. OpenTelemetry Collector (Збирає дані)
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./observability/otel-collector-config.yaml:/etc/otel-collector-config.yaml
    ports:
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP HTTP receiver
      - "8889:8889" # Prometheus exporter metrics

  # 2. Prometheus (Зберігає метрики)
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yaml
      - --web.enable-remote-write-receiver
      - --enable-feature=exemplar-storage
    volumes:
      - ./observability/prometheus.yaml:/etc/prometheus/prometheus.yaml
    ports:
      - "9090:9090"

  # 3. Tempo (Зберігає трейси)
  tempo:
    image: grafana/tempo:latest
    container_name: tempo
    command: [ "-config.file=/etc/tempo.yaml" ]
    volumes:
      - ./observability/tempo-config.yaml:/etc/tempo.yaml # (Використаємо дефолтний, якщо не створили, або додамо нижче)
      # Для простоти можна використовувати дефолтний конфіг всередині образу, 
      # але краще створити простий файл tempo.yaml, якщо будуть помилки.
    ports:
      - "3200:3200"
      - "4317"  # otlp grpc

  # 4. Loki (Зберігає логи)
  loki:
    image: grafana/loki:latest
    container_name: loki
    # Вказуємо використовувати наш файл конфігурації
    command: -config.file=/etc/loki/loki.yaml 
    volumes:
      # Прокидаємо файл всередину контейнера
      - ./observability/loki.yaml:/etc/loki/loki.yaml
    ports:
      - "3100:3100"

  # 5. Grafana (Візуалізація всього)
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    volumes:
      - ./observability/datasource.yaml:/etc/grafana/provisioning/datasources/datasource.yaml
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - tempo
      - loki